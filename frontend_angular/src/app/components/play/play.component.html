<div class="play">
  <div *ngIf="authService.isAuthenticated()">
    <div *ngIf="error">
      There's not current active session. Please go back to the <a (click)="navigateToQuizzes()" class="link-like">quizzes page</a> and start a new session.
    </div>

    <div *ngIf="!error && readyToInvite && !gameLaunched">
      <h1>
        Welcome to this session.
      </h1>

      <h2>
        Join the game scanning this QR code
      </h2>
      <div class="qr-code-container">
        <qrcode [qrdata]="url" [width]="200" [errorCorrectionLevel]="'M'" style="padding: 0px !important;"></qrcode>
      </div>

      <div class="current-players">
        <h3>
          Current players
        </h3>
        <div *ngIf="players.length > 0">
          <div cdkDropList (cdkDropListDropped)="drop($event)" class="player-grid">
            <div *ngFor="let player of players" [ngClass]="playerClasses[player.username]" cdkDrag class="player-item">
              {{ player.username }}
            </div>
          </div>
        </div>
        <div *ngIf="players.length==0">
          No players yet.
        </div>
      </div>
      <div>
        <button mat-stroked-button color="primary" (click)="launchTheGame()">Launch the game</button>
      </div>
    </div>
    <div *ngIf="!error && readyToInvite && gameLaunched && currentQuestion.question===''">
      <button mat-stroked-button color="primary" (click)="nextQuestion()">Next question</button>
    </div>
  </div>

  <div *ngIf="!authService.isAuthenticated() && !joined">
    <div *ngIf="isReady && myName==''">
      <form [formGroup]="setUsernameForm" class="form-fields" @fadeInOut (ngSubmit)="setUsername()">
        <div>
          <mat-form-field appearance="outline">
            <mat-label>Enter your username</mat-label>
            <input matInput placeholder="yourNickname" formControlName="username" required>
            <mat-icon matSuffix>person_outline</mat-icon>
            <mat-error *ngIf="(setUsernameForm.get('username')?.invalid)">
              {{getErrorMessage('username')}}
            </mat-error>
          </mat-form-field>
        </div>
        <div class="form-buttons">
          <button type="submit" mat-stroked-button color="primary" [disabled]="setUsernameForm.invalid">Play</button>
          <button mat-stroked-button color="accent" (click)="setUsernameCancel()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="joined && !gameLaunched">
    <div class="container">
      <p>You joined the game with success. </p>
      <p>Please wait for the host to start the game.</p>
    </div>
  </div>

  <div *ngIf="joined && gameLaunched && currentQuestion.question==''">
    <div class="container">
      <p>The game is about to start. </p>
      <p>Get ready!</p>
    </div>
    <div *ngIf="authService.isAuthenticated()">
      <button mat-stroked-button color="primary" (click)="nextQuestion()">Next question</button>
    </div>
  </div>

  <div *ngIf="(joined && gameLaunched && currentQuestion.question!='' && currentAnswer<=0)||(authService.isAuthenticated() && gameLaunched && currentQuestion.question!='')">
    <div class="question" *ngIf="(joined && gameLaunched && currentQuestion.question!='' && currentAnswer<=0)||(authService.isAuthenticated() && thisQuestionResult.players.length==0)">
      <h1>
        {{ currentQuestion.question }}
      </h1>
      <div class="answers">
        <div *ngIf="!authService.isAuthenticated()">
          <div *ngFor="let choice of currentQuestion.choices" class="answer" (click)="answerQuestion(choice.choiceId)">
            {{ choice.choice }}
          </div>
        </div>
        <div *ngIf="authService.isAuthenticated()">
          <div *ngFor="let choice of currentQuestion.choices" class="answer">
            {{ choice.choice }}
          </div>
        </div>
      </div>
      <div *ngIf="authService.isAuthenticated()">
        <button mat-stroked-button color="primary" (click)="showResults()">Show results</button>
      </div>
    </div>


    <div *ngIf="authService.isAuthenticated() && gameLaunched && currentQuestion.question!='' && showGoodAnswers && !showQuestionResult && !showGlobalResult">
      <h1>
        {{ currentQuestion.question }}
      </h1>
      <div class="answers">
        <div
                *ngFor="let choice of currentQuestion.choices"
                [ngClass]="{'answer': true, 'correct': choice.isCorrect, 'incorrect': !choice.isCorrect}"
        >
          <mat-icon matSuffix *ngIf="choice.isCorrect">done</mat-icon>{{ choice.choice }}
        </div>
      </div>
      <div>
        <button mat-stroked-button color="primary" (click)="showQuestionResultsFunc()">Question Result</button>
      </div>
    </div>


    <div *ngIf="authService.isAuthenticated() && gameLaunched && currentQuestion.question!='' && !showGoodAnswers && showQuestionResult && !showGlobalResult">
      <h1>
        Question ranking
      </h1>
      <div class="results">
        <div *ngFor="let player of thisQuestionResult.players" class="player-result">
          <div class="player-name">
            {{ player.username }}
          </div>
          <div class="player-score">
            {{ player.currentScore }}
          </div>
        </div>
      </div>
      <div>
        <button mat-stroked-button color="primary" (click)="showGlobalResultsFunc()">Global Result</button>
      </div>
    </div>

    <div *ngIf="authService.isAuthenticated() && gameLaunched && currentQuestion.question!='' && !showQuestionResult && showGlobalResult">
      <h1>
        <span *ngIf="!gameIsOver">Global ranking</span>
        <span *ngIf="gameIsOver">Final global ranking</span>
      </h1>
      <div class="results">
        <div *ngFor="let player of currentResult.players" class="player-result">
          <div class="player-name">
            {{ player.username }}
          </div>
          <div class="player-score">
            {{ player.currentScore }}
          </div>
        </div>
      </div>
      <div *ngIf="!gameIsOver">
        <button mat-stroked-button color="primary" (click)="nextQuestionFunc()">Next question</button>
      </div>
      <div *ngIf="gameIsOver">
        <button mat-stroked-button color="primary" (click)="navigateToQuizzes()" class="link-like">Back to quizzes page</button>
      </div>
    </div>
  </div>


  <div *ngIf="joined && gameLaunched && currentQuestion.question!='' && currentAnswer>0 && !gameIsOver">
    <div *ngIf="!authService.isAuthenticated()">
      <div class="container">
        <p>Please wait for the results and the next question</p>
      </div>
    </div>
  </div>
  <div *ngIf="joined && gameLaunched && currentQuestion.question!='' && currentAnswer>0 && gameIsOver">
    <div *ngIf="!authService.isAuthenticated()">
      <div class="container">
        <p>Checks results on the main screen. </p>
        <p>Thanks for playing! </p>
      </div>
    </div>
  </div>
  <div *ngIf="authService.isAuthenticated() && joined && gameLaunched && currentQuestion.question!='' && !gameIsOver && currentResult!={players: []}">
    results are...
    <div *ngFor="let player of currentResult.players">
      {{ player.username }}: {{ player.currentScore }}
    </div>
  </div>

</div>
